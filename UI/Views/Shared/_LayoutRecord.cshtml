@model BaseRecordViewModel
@inject BL.Factory _f

<!DOCTYPE html>

<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@(Model.PageTitle) | MARKTIME</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/kendo/styles/kendo.common.min.css" type="text/css" />
    <link href="~/lib/datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />
    <link href="~/lib/qtip/jquery.qtip.css" rel="stylesheet" type="text/css" />
    <link href="~/lib/autocomplete/jquery.autocomplete.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="~/css/@_f.CurrentUser.getFontSizeCss()" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="@_f.App.CssCustomSkin" />
    <link rel="stylesheet" href="~/css/thegrid.css" />


    @if (IsSectionDefined("header_content"))
    {
        @RenderSection("header_content")
    }
</head>
<body>
    <script type="text/javascript">
        var _relpath = "@(Url.Content("~/favicon.ico").Replace("favicon.ico",""))";   //relativní cesta: detekce kvůli případnému IIS virtuálnímu adresáři

        var event_form1_beforesave = new CustomEvent("form1_beforesave", { detail: { cancel: false } });

    </script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script src="~/lib/datepicker/bootstrap-datepicker.min.js"></script>
    <script src="~/lib/qtip/jquery.qtip.min.js"></script>
    <script src="~/lib/autocomplete/jquery.autocomplete.min.js"></script>

    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/mycombo.js" asp-append-version="true"></script>
    <script src="~/js/thegrid.js" asp-append-version="true"></script>
    <script src="~/js/contextmenu.js" asp-append-version="true"></script>
    <script src="~/js/mycontrols.js" asp-append-version="true"></script>

    <script type="text/javascript">
        @if(Model.Javascript_CallOnLoad != null)
    {
        @Html.Raw(Model.Javascript_CallOnLoad);


    }


    </script>


    <div>
        <h4>
            @if (Model.PageSymbol != null)
            {
                @Html.Raw(Model.PageSymbol)
            }
            @Model.PageTitle
        </h4>

        <form id="form1" asp-controller="@Model.rec_entity" asp-action="@Model.form_action" method="POST">
            <input type="hidden" asp-for="@Model.rec_pid" />
            <input type="hidden" asp-for="@Model.rec_entity" />
            <input type="hidden" asp-for="@Model.ActiveTabIndex" />
            <input type="hidden" asp-for="@Model.form_action" />


            @Html.EditorFor(m => m.Toolbar, "~/Views/Shared/_MyToolbar.cshtml")

            @RenderBody()

        </form>
        <div style="border-top:solid 1px #F5F5F5;margin-top:20px;">
            @if (Model.rec_pid > 0)
            {
                @Html.Raw(Model.Toolbar.getTimeStampHtml(_f));



            }
            @if (Model.Toolbar.AllowArchive)
            {
                <button type="button" onclick="toolbar_handle_validity(event)" class="btn btn-light btn-sm px-0">@_f.tra("Časová platnost ručně")</button>
            }
        </div>
    </div>
    @if (IsSectionDefined("after_form"))
    {
        @RenderSection("after_form")
    }



    <script type="text/javascript">
        var _modal;

    $(document).ready(function ()
    {


        if (document.getElementById("link_tab1")) {
            $("#tab@(Model.ActiveTabIndex)").attr("class", "tab-pane active");
            $("#link_tab@(Model.ActiveTabIndex)").attr("class", "nav-link active");

            $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
                // v e.target.id je id kliknutá záložka

                var tabindex = e.target.id.substring(e.target.id.length - 1, e.target.id.length);
                $("#ActiveTabIndex").val(tabindex);
                _resize_textareas();
            })
        }


        @if (_f.CurrentUser.Messages4Notify != null) {
            @foreach (var c in _f.CurrentUser.Messages4Notify) {  // <----  placed on the same line, WORKING !!!

                @:_notify_message("@Html.Raw(c.Value)","@c.Key");

            }
        }
        if ($("#toolbar_changeinfo").length) {
            //události na editačních formulářích
            $("form").submit(function () {
                if ($(document.activeElement).attr("type") == "submit")
                    return true;
                else return false;
            });

            _resize_textareas();
        }



        $(document).on("click", function (e) {
            if (e.target == _modal) {
                _window_in_modal_close();
            }
        });
        $(document).on("keydown", function (e) {
            if (_modal != null && e.keyCode == 27 && _modal.style.display == "block") {
                _window_in_modal_close();

            }
            if (e.keyCode == 13 && e.target.nodeName != "BUTTON" && e.target.nodeName != "TEXTAREA") {                //zabránit submit formuláře po stisknutí ENTER na jakémkoliv non-submit input elementu
                e.preventDefault();
                return false;
            }
        });




        _init_qtip_onpage(document);



    });



        function _window_close() {

            if (document.getElementById("myModalContainer")) {
                if ($(_modal).css("display") == "block") {  //test, zda o zavření volá modální okno nebo okno otevřené z modálního okna (3.vrstva)
                    _window_in_modal_close();
                    return;
                }
            }

            if (window != top) {

                window.parent._window_close();  //toto okno je uvnitř iframe
            } else {
                window.close();
            }
        }

        function _window_in_modal_close() {
            var iframe = document.getElementById("fraModalContent");
            var elmnt = iframe.contentWindow.document.getElementById("toolbar_changeinfo");
            if ($(elmnt).text() !== "") {
                if (confirm("@_f.tra("Chcete zavřít okno bez uložení změn?")")) {
                    $(_modal).css("display", "none");
                } else {
                    return;
                }
            }
            $(_modal).css("display", "none");
        }

        function _window_open(url, flag, header, layout) {
            if (typeof header === "undefined") header = "";
            if (document.getElementById("myModalContainer")) {
                //modal div na stránce již existuje
                $("#fraModalContent").css("visibility", "hidden");
                $("#iframe_is_loading").text("Loading...");
            } else {
                var el = document.createElement("DIV");
                $(el).css("position", "absolute");

                el.id = "myModalContainer";
                document.body.appendChild(el);

                var s = "<div id='myModalContent'>";
                s+= "<div style='height:30px;background-color: green;color:white;padding:3px;'>";
                s += "<button class='btn btn-success btn-sm float-left' onclick='_window_in_modal_close()' style='margin-left:3px;margin-right:3px;'>&times;</button>";
                s += "<span>" + header + "</span><span id='iframe_is_loading'>Loading...</span>";
                s += "<button class='btn btn-success btn-sm float-end' onclick='_window_in_modal_close()' style='margin-right:3px;'>&times;</button>";
                s += "</div>";
                s += "<div id='myModalFrame' style='padding: 0px; margin:0px 0px 0px 10px; overflow: auto; -webkit-overflow-scrolling: touch;'>";
                s += "<iframe id='fraModalContent' name='fraModalContent' frameborder='0' onload='iframe_loaded()'></iframe>";
                s += "</div>";
                s += "</div>";

                _modal = document.getElementById("myModalContainer");
                $(_modal).html(s);
                _make_element_draggable(document.getElementById("myModalContent"), document.getElementById("myModalFrame")); //předávání nefunguje přes jquery
            }


            var okno = $("#myModalContent");
            var fra = $("#fraModalContent");

            var w = window.innerWidth - 40;

            var h = window.innerHeight-30;
            var x = 0;
            var y = 0;

            $(okno).css("width", w);
            $(okno).css("height", h);
            $(okno).css("left", x);
            $(okno).css("top", y);
            $(fra).css("width", w - 15);
            $(fra).css("height", h - 30 - 10);    //10 padding dole, 30 div header

            if (url !== "") {
                url = _ep(url);
                $(fra).attr("src", url);
            }


            $(_modal).css("display", "block");
    }


        function iframe_loaded() {
            $("#fraModalContent").css("visibility", "visible");
            $("#iframe_is_loading").text("");
        }



    </script>

    @RenderSection("Scripts", required: false)


</body>
</html>


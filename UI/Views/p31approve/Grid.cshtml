@model UI.Models.p31approve.GatewayViewModel
@inject BL.Factory _f

@{
    Layout = "~/Views/Shared/_LayoutModal.cshtml";
    Model.PageTitle = _f.tra("Schvalování");

}

@addTagHelper *, UI

<form id="form1" asp-controller="p31approve" asp-action="Grid" method="POST">
    <div class="bg-light input-group m-0" style="padding:10px;">
        <button type="button" id="cmdSaveOnly" class="btn btn-success m-1">@_f.tra("Pouze uložit schvalování")</button>
        <button type="button" id="cmdSaveAndBilling" class="btn btn-primary m-1">@_f.tra("Uložit schvalování a pokračovat vyúčtováním")</button>


        <div class="dropdown m-1">
            <button class="btn btn-light dropdown-toggle" type="button" id="cmdGridMenu" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="TheGridIcon" class="k-icon k-i-table"></span>
                <span id="TheGridName">Grid<strong> & </strong>@_f.tra("Sloupce")</span>
            </button>
            <div id="divGridMenu" class="dropdown-menu" aria-labelledby="cmdGridMenu">
                Loading...
            </div>
        </div>

        <button type="button" id="cmdClose" onclick="_window_close()" class="btn btn-light">@_f.tra("Zavřít")</button>


    </div>



    <input type="hidden" asp-for="@Model.guid" />
    <input type="hidden" asp-for="@Model.j72ID" />
    <input type="hidden" asp-for="@Model.Rec_Pid" />
    <input type="hidden" asp-for="@Model.Rec_p33ID" />
</form>
@if (_f.CurrentUser.j03Ping_InnerWidth > 1200)
{
    <table cellpadding="0" cellspacing="0" width="100%">
        <tr style="vertical-align:top;">
            <td>
                <vc:the-grid input="@Model.gridinput"></vc:the-grid>
            </td>
            <td style="width:300px;">
                <h5 id="recNadpis">@_f.tra("Vyberte úkon")</h5>
                
                <table id="tabRecord" style="display:none;">
                    <tr>
                        <td colspan="2">
                            <button type="button" class="btn btn-success">@_f.tra("Uložit změny")</button>
                            <hr />


                            <input type="radio" id="chkp71ID_1" asp-for="Rec_p71ID" value="1" onchange="handle_rec_change()" />
                            <label for="chkp71ID_1">@_f.tra("Schváleno")</label>
                            <input type="radio" id="chkp71ID_2" asp-for="Rec_p71ID" value="2" onchange="handle_rec_change()" style="margin-left:5px;" />
                            <label for="chkp71ID_2">@_f.tra("Neschváleno")</label>
                            <input type="radio" id="chkp71ID_0" asp-for="Rec_p71ID" value="0" onchange="handle_rec_change()" style="margin-left:5px;" />
                            <label for="chkp71ID_0">@_f.tra("Rozpracováno")</label>
                        </td>
                    </tr>
                    <tr id="trP72ID">
                        <td colspan="2">
                            <hr />
                            <input type="radio" id="chkp72ID_4" asp-for="Rec_p72ID" value="4" onchange="handle_rec_change()" />
                            <label for="chkp72ID_4" class="badge-a4">@_f.tra("Fakturovat")</label>
                            <br />
                            <input type="radio" id="chkp72ID_6" asp-for="Rec_p72ID" value="6" onchange="handle_rec_change()" />
                            <label for="chkp72ID_6" class="badge-a6">@_f.tra("Zahrnout do paušálu")</label>
                            <br />
                            <input type="radio" id="chkp72ID_3" asp-for="Rec_p72ID" value="3" onchange="handle_rec_change()" />
                            <label for="chkp72ID_3" class="badge-a3">@_f.tra("Skrytý odpis")</label>
                            <br />
                            <input type="radio" id="chkp72ID_2" asp-for="Rec_p72ID" value="2" onchange="handle_rec_change()" />
                            <label for="chkp72ID_2" class="badge-a2">@_f.tra("Viditelný odpis")</label>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:120px;">
                            @_f.tra("Datum"):
                        </td>
                        <td>
                            <span class="val-readonly-wrap" id="Rec_Datum"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            @_f.tra("Jméno"):
                        </td>
                        <td>
                            <span class="val-readonly" id="Rec_Jmeno"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <span id="lblProjekt">@_f.tra("Projekt"):</span>
                        </td>
                        <td>
                            <span class="val-readonly-wrap" id="Rec_Projekt"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            @_f.tra("Aktivita"):
                        </td>
                        <td>
                            <span class="val-readonly" id="Rec_Aktivita"></span>
                        </td>
                    </tr>
                    <tr id="trHodinyKFakturaci" data-p33id="1">
                        <td>
                            @_f.tra("Hodiny k fakturaci"):
                        </td>
                        <td>
                            <myhours asp-for="@Model.Rec_HodinyKFakturaci" showsettingbutton="true" hoursentryformat="@(_f.CurrentUser.j03DefaultHoursFormat)" hoursentryflag="@(_f.CurrentUser.j03HoursEntryFlagV7)"></myhours>
                        </td>
                    </tr>
                    <tr id="trSazbaKFakturaci" data-p33id="13">
                        <td>
                            @_f.tra("Fakturační sazba"):
                        </td>
                        <td>
                            <mynumber asp-for="@Model.Rec_SazbaKFakturaci"></mynumber>
                        </td>
                    </tr>
                    <tr id="trHodinyVPausalu" data-p33id="1">
                        <td>
                            @_f.tra("Hodiny v paušálu"):
                        </td>
                        <td>
                            <myhours asp-for="@Model.Rec_HodinyVPausaulu" showsettingbutton="true" hoursentryformat="@(_f.CurrentUser.j03DefaultHoursFormat)" hoursentryflag="@(_f.CurrentUser.j03HoursEntryFlagV7)"></myhours>
                        </td>
                    </tr>

                    <tr id="trBezDph" data-p33id="25">
                        <td>
                            @_f.tra("Cena k fakturaci"):
                        </td>
                        <td>
                            <mynumber asp-for="@Model.Rec_BezDph"></mynumber>
                        </td>
                    </tr>
                    <tr id="trDphSazba" data-p33id="25">
                        <td>
                            @_f.tra("DPH sazba %"):
                        </td>
                        <td>
                            <mynumber asp-for="@Model.Rec_DphSazba"></mynumber>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <textarea class="form-control" id="Rec_Popis"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            @_f.tra("Úroveň schvalování"):
                        </td>
                        <td>
                            <select asp-for="@Model.Rec_UrovenSchvalovani">
                                <option value="0">#0</option>
                                <option value="1">#1</option>
                                <option value="2">#2</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
}
else
{
    <vc:the-grid input="@Model.gridinput"></vc:the-grid>
}







<script type="text/javascript">
    var _guid = "@Model.guid";

    $(document).ready(function () {

        document.addEventListener("thegrid_rowselect", function (e) {       //změna řádku gridu: automaticky vyvolávaná událost z gridu
            thegrid_handle_rowselect(e.detail.pid);
        });


    });


    function thegrid_handle_rowselect(pid) {     
        $("#tabRecord").css("display", "block");
        $("#recNadpis").css("display", "none");

        $.post(_ep("/p31approve/LoadGridRecord"), { p31id: pid, guid: _guid }, function (data) {
            
            $("#Rec_Pid").val(pid);
            $("#Rec_p33ID").val(data.p33id);
                        
            $("#chkp71ID_" + data.p71id).prop("checked", true);
            if (data.p72id > 0)
            {
                $("#chkp72ID_" + data.p72id).prop("checked", true);
            }
            
            $("#Rec_Jmeno").text(data.jmeno);
            $("#Rec_Datum").text(data.datum);
            $("#Rec_Projekt").text(data.projekt);
            $("#Rec_Aktivita").text(data.aktivita);
            $("#Rec_Popis").text(data.popis);
            $("#Rec_UrovenSchvalovani").val(data.uroven);

            

            if (data.p33id == 1) {                
                $("#Rec_HodinyKFakturaci").val(data.hodiny);
                $("#Rec_HodinyVPausaulu").val(data.hodinypausal);
                
            }
            if (data.p33id == 1 || data.p33id==3) {                               
                mynumber_changevalue("Rec_SazbaKFakturaci", data.sazba, 2);

            } else {                
                
                mynumber_changevalue("Rec_DphSazba", data.dphsazba, 0);
                mynumber_changevalue("Rec_BezDph", data.bezdph, 2);
            }


            
            handle_rec_change();
            
            
            $("#lblProjekt").html(data.pl+":");
            _resize_textareas();
        });
    }

    function handle_rec_change() {
        var p71id = $('input[name=Rec_p71ID]:checked').val();
        var p72id = $('input[name=Rec_p72ID]:checked').val();
        var p33id = $("#Rec_p33ID").val();

        $("#trP72ID").css("visibility", "visible");
        $("[data-p33id=1]").css("visibility", "visible");
        $("[data-p33id=13]").css("visibility", "visible");
        $("[data-p33id=25]").css("visibility", "visible");

        if (p71id == "0" || p71id == "2") {
            $("#trP72ID").css("visibility", "hidden");
            $("[data-p33id=1]").css("visibility", "hidden");
            $("[data-p33id=13]").css("visibility", "hidden");
            $("[data-p33id=25]").css("visibility", "hidden");
        }
        
        //následně už pouze skrývat (hidden) nepotřebné, protože aktuálně je vše viditelné!

        if (p33id == 1 || p33id==3 || p72id==6 || p72id==3 || p72id==2) {
            $("#trDphSazba").css("visibility", "hidden");
            $("#trBezDph").css("visibility", "hidden");
            
        }
        if (p33id != 1) {
            $("#trHodinyKFakturaci").css("visibility", "hidden");
        }
        if (p33id != 1 && p33id != 3) {
            $("#trSazbaKFakturaci").css("visibility", "hidden");
        }
        if ((p33id == 1 && p72id != 6) || p33id>1) {
            $("#trHodinyVPausalu").css("visibility", "hidden");
        }
        if ((p33id == 1 || p33id == 3) && (p72id==6 || p72id==3 || p72id==2)) {
            $("#trSazbaKFakturaci").css("visibility", "hidden");
            $("#trHodinyKFakturaci").css("visibility", "hidden");
        }
        
    }


    function postback(oper) {

        form1.action = _ep("/p31approve/Grid?oper=" + oper);
        form1.submit();
    }

    

    function hardrefresh(pid, flag) {
        postback("postback");
    }
</script>
